<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AI Workspace</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #f4f6fb;
            --surface: #ffffff;
            --surface-alt: #f8f9ff;
            --border: #d8deed;
            --shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
            --accent: #5661f6;
            --accent-dark: #3a45d3;
            --accent-soft: rgba(86, 97, 246, 0.1);
            --text: #1f2937;
            --text-muted: #526074;
            --success: #0fa958;
            --warning: #ffb347;
            --danger: #e24d4d;
            --radius-lg: 18px;
            --radius-md: 14px;
            --radius-sm: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #eef1ff 0%, #fdfbff 50%, #eef7ff 100%);
            color: var(--text);
            padding: 24px;
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
        }

        main {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 18px;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.8rem, 3vw, 2.4rem);
            line-height: 1.2;
        }

        .subtitle {
            margin: 0;
            color: var(--text-muted);
            max-width: 820px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .control-card {
            flex: 1 1 280px;
            min-width: 260px;
            background: var(--surface-alt);
            border-radius: var(--radius-md);
            padding: 18px;
            border: 1px solid var(--border);
        }

        .control-card h2 {
            margin: 0 0 12px;
            font-size: 1.05rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
        }

        select,
        input,
        textarea,
        button {
            font-family: inherit;
        }

        select,
        input[type="url"],
        input[type="search"],
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        select:focus,
        input[type="url"]:focus,
        input[type="search"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        button:hover,
        button:focus {
            background: var(--accent-dark);
        }

        button:active {
            transform: translateY(1px);
        }

        button.secondary {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent-soft);
        }

        button.secondary:hover,
        button.secondary:focus {
            background: var(--accent-soft);
        }

        .panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        article.panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--surface-alt);
            border-radius: var(--radius-md);
            padding: 18px;
            border: 1px solid var(--border);
        }

        .panel header {
            border: none;
            padding: 0;
        }

        .panel header h2 {
            margin: 0;
            font-size: 1.15rem;
        }

        .panel header p {
            margin: 4px 0 0;
            color: var(--text-muted);
            font-size: 0.92rem;
        }

        .conversation-log {
            min-height: 220px;
            max-height: 320px;
            overflow-y: auto;
            background: #fff;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .empty-state {
            margin: 0;
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 40px 12px;
        }

        .message {
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            position: relative;
            display: grid;
            gap: 6px;
            border: 1px solid transparent;
        }

        .message.user {
            background: #eef0ff;
            border-color: rgba(86, 97, 246, 0.15);
        }

        .message.assistant {
            background: #f4f9ff;
            border-color: rgba(56, 189, 248, 0.12);
        }

        .message-meta {
            display: flex;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-muted);
            gap: 10px;
        }

        .message-body {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message-context {
            margin: 4px 0 0;
            padding: 0;
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .message-context li {
            background: var(--accent-soft);
            color: var(--accent-dark);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
        }

        .message-actions {
            display: flex;
            gap: 8px;
        }

        .message-actions button {
            padding: 6px 10px;
            font-size: 0.75rem;
        }

        form.message-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        form.message-form textarea {
            resize: vertical;
            min-height: 70px;
            max-height: 160px;
        }

        .notebook {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
        }

        .notebook h3 {
            margin: 0 0 8px;
            font-size: 1rem;
        }

        .notebook-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .notebook-entry {
            background: var(--surface-alt);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            border: 1px solid var(--border);
        }

        .notebook-entry time {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .notebook-entry button {
            margin-top: 6px;
            padding: 4px 8px;
            font-size: 0.72rem;
        }

        .attachment-list {
            list-style: none;
            padding: 0;
            margin: 12px 0 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 160px;
            overflow-y: auto;
        }

        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            gap: 12px;
        }

        .attachment-item span {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .attachment-item .badge {
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--accent-soft);
            color: var(--accent-dark);
        }

        .history-card,
        .tests-card,
        .accessibility-card {
            background: var(--surface-alt);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            padding: 18px;
        }

        .history-results {
            margin: 14px 0 0;
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-result {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
        }

        .history-result strong {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .history-result p {
            margin: 6px 0 0;
            font-size: 0.9rem;
        }

        .tests-card ol {
            padding-left: 18px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .test-pass {
            color: var(--success);
            font-weight: 600;
        }

        .test-fail {
            color: var(--danger);
            font-weight: 600;
        }

        .model-details {
            margin: 10px 0 0;
            color: var(--text-muted);
            font-size: 0.92rem;
        }

        .badge-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--accent-soft);
            color: var(--accent-dark);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .visually-hidden {
            position: absolute;
            clip: rect(0 0 0 0);
            clip-path: inset(50%);
            width: 1px;
            height: 1px;
            overflow: hidden;
            white-space: nowrap;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body>
<main id="workspace" aria-labelledby="workspaceTitle">
    <header>
        <h1 id="workspaceTitle">Unified Web AI Workspace</h1>
        <p class="subtitle">Coordinate research, coding, and financial analysis without context-switching. Attach source material, choose the optimal model, stream insights in real time, and preserve critical results in structured notebooks.</p>
    </header>

    <section class="controls" aria-label="Workspace global controls">
        <div class="control-card" role="group" aria-labelledby="modelSelectorLabel">
            <h2 id="modelSelectorLabel">Model selector</h2>
            <label for="modelSelect">Route messages with</label>
            <select id="modelSelect" aria-describedby="modelDetails">
                <option value="auto-routing" data-cost="Varies per routed model" data-description="Automatically selects a specialized model per panel while keeping attachments in scope.">Auto Routing (context-aware orchestrator)</option>
                <option value="atlas-pro" data-cost="$12 / million tokens" data-description="Balanced reasoning model suited for cross-domain analysis.">Atlas Pro &mdash; generalist insights</option>
                <option value="code-strata" data-cost="$8 / million tokens" data-description="Coding-specialized model with structured reasoning for refactors and reviews.">Code Strata &mdash; code generation focus</option>
                <option value="quant-sage" data-cost="$15 / million tokens" data-description="Finance model tuned for risk and forecasting analysis.">Quant Sage &mdash; financial modeling</option>
                <option value="nova-lite" data-cost="$4 / million tokens" data-description="Lightweight brainstorming model with rapid responses.">Nova Lite &mdash; rapid ideation</option>
            </select>
            <p id="modelDetails" class="model-details" aria-live="polite">Cost: varies per routed model. Auto routing chooses Atlas Pro for research, Code Strata for coding, and Quant Sage for finance.</p>
        </div>

        <div class="control-card" role="group" aria-labelledby="attachmentsLabel">
            <h2 id="attachmentsLabel">Context attachments</h2>
            <p class="subtitle" style="margin:0 0 10px;font-size:0.9rem;">Supplement responses with reference files or URLs. Active context is shared across panels.</p>
            <label for="fileInput">Attach reference file</label>
            <input id="fileInput" type="file" aria-describedby="attachmentHint" multiple>
            <div id="attachmentHint" class="model-details">Files stay local; only metadata is stored for context tracking.</div>
            <label for="urlInput">Attach supporting URL</label>
            <div style="display:flex;gap:8px;align-items:center;">
                <input id="urlInput" type="url" placeholder="https://example.com/insight" aria-label="URL to attach">
                <button type="button" id="addUrlBtn" class="secondary">Add URL</button>
            </div>
            <ul id="attachmentList" class="attachment-list" role="list" aria-live="polite"></ul>
        </div>

        <div class="control-card history-card" role="group" aria-labelledby="historySearchLabel">
            <h2 id="historySearchLabel">History search</h2>
            <label for="historySearchInput">Search across conversations</label>
            <input id="historySearchInput" type="search" placeholder="Search for keywords or model names" aria-describedby="historyHelper">
            <div id="historyHelper" class="model-details">Results update live with context from all panels.</div>
            <ul id="historyResults" class="history-results" role="list" aria-live="polite"></ul>
        </div>
    </section>

    <section class="panels" role="region" aria-label="Conversation panels">
        <article class="panel" data-domain="research" aria-labelledby="researchPanelTitle" role="region">
            <header>
                <h2 id="researchPanelTitle">Research intelligence</h2>
                <p>Surface evidence-backed summaries and literature insights.</p>
            </header>
            <div class="conversation-log" id="conversation-research" role="log" aria-live="polite" aria-relevant="additions text" aria-label="Research conversation"></div>
            <form class="message-form" data-domain="research">
                <label class="visually-hidden" for="input-research">Message for research assistant</label>
                <textarea id="input-research" placeholder="Ask for academic findings or qualitative analysis" required></textarea>
                <button type="submit">Send to research assistant</button>
            </form>
            <div class="notebook" aria-live="polite" aria-label="Research notebook">
                <h3>Research notebook</h3>
                <p class="model-details" style="margin:0 0 12px;">Capture validated findings from assistant replies.</p>
                <ul id="notebook-research" class="notebook-list" role="list"></ul>
            </div>
        </article>

        <article class="panel" data-domain="coding" aria-labelledby="codingPanelTitle" role="region">
            <header>
                <h2 id="codingPanelTitle">Coding copiloting</h2>
                <p>Pair program on refactors, reviews, and generation tasks.</p>
            </header>
            <div class="conversation-log" id="conversation-coding" role="log" aria-live="polite" aria-relevant="additions text" aria-label="Coding conversation"></div>
            <form class="message-form" data-domain="coding">
                <label class="visually-hidden" for="input-coding">Message for coding assistant</label>
                <textarea id="input-coding" placeholder="Describe code goals, debugging steps, or refactors" required></textarea>
                <button type="submit">Send to coding assistant</button>
            </form>
            <div class="notebook" aria-live="polite" aria-label="Coding notebook">
                <h3>Coding notebook</h3>
                <p class="model-details" style="margin:0 0 12px;">Store implementation decisions and code snippets.</p>
                <ul id="notebook-coding" class="notebook-list" role="list"></ul>
            </div>
        </article>

        <article class="panel" data-domain="finance" aria-labelledby="financePanelTitle" role="region">
            <header>
                <h2 id="financePanelTitle">Financial analytics</h2>
                <p>Generate scenario plans, risk assessments, and financial briefs.</p>
            </header>
            <div class="conversation-log" id="conversation-finance" role="log" aria-live="polite" aria-relevant="additions text" aria-label="Finance conversation"></div>
            <form class="message-form" data-domain="finance">
                <label class="visually-hidden" for="input-finance">Message for finance assistant</label>
                <textarea id="input-finance" placeholder="Assess portfolio risk, forecasts, or financial narratives" required></textarea>
                <button type="submit">Send to finance assistant</button>
            </form>
            <div class="notebook" aria-live="polite" aria-label="Finance notebook">
                <h3>Finance notebook</h3>
                <p class="model-details" style="margin:0 0 12px;">Bookmark key forecasts and decision frameworks.</p>
                <ul id="notebook-finance" class="notebook-list" role="list"></ul>
            </div>
        </article>
    </section>

    <section class="accessibility-card" aria-labelledby="accessibilityHeading">
        <h2 id="accessibilityHeading">Accessibility review log</h2>
        <p id="accessibilityReviewLog" data-reviewed="false" aria-live="polite"></p>
    </section>

    <section class="tests-card" aria-labelledby="testsHeading">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 id="testsHeading" style="margin:0;">Workspace regression checks</h2>
            <button type="button" id="rerunTests" class="secondary">Re-run tests</button>
        </div>
        <p class="model-details" style="margin:12px 0 16px;">Automated smoke tests verify persistence, routing logic, and accessibility logging.</p>
        <ol id="testResults"></ol>
    </section>

    <div id="liveRegion" class="visually-hidden" role="status" aria-live="polite"></div>
</main>

<script>
(function initializeWorkspace() {
    const STORAGE_KEY = 'web-ai-workspace-state-v1';
    const DOMAINS = ['research', 'coding', 'finance'];
    const MODEL_ROUTING = {
        research: 'atlas-pro',
        coding: 'code-strata',
        finance: 'quant-sage'
    };

    const defaultState = {
        selectedModel: 'auto-routing',
        attachments: [],
        conversations: {
            research: [],
            coding: [],
            finance: []
        },
        notebooks: {
            research: [],
            coding: [],
            finance: []
        }
    };

    const clone = typeof globalThis.structuredClone === 'function'
        ? value => globalThis.structuredClone(value)
        : value => JSON.parse(JSON.stringify(value));

    let state = clone(defaultState);

    const modelSelect = document.getElementById('modelSelect');
    const modelDetails = document.getElementById('modelDetails');
    const liveRegion = document.getElementById('liveRegion');
    const historyInput = document.getElementById('historySearchInput');
    const historyResults = document.getElementById('historyResults');
    const attachmentList = document.getElementById('attachmentList');
    const accessibilityLog = document.getElementById('accessibilityReviewLog');
    const rerunTestsBtn = document.getElementById('rerunTests');

    function announce(message) {
        liveRegion.textContent = '';
        window.requestAnimationFrame(() => {
            liveRegion.textContent = message;
        });
    }

    function generateId() {
        return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
    }

    function loadState() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = {
                    ...clone(defaultState),
                    ...parsed,
                    attachments: parsed.attachments || [],
                    conversations: {
                        research: parsed?.conversations?.research || [],
                        coding: parsed?.conversations?.coding || [],
                        finance: parsed?.conversations?.finance || []
                    },
                    notebooks: {
                        research: parsed?.notebooks?.research || [],
                        coding: parsed?.notebooks?.coding || [],
                        finance: parsed?.notebooks?.finance || []
                    }
                };
            }
        } catch (error) {
            console.error('Failed to load workspace state:', error);
            state = clone(defaultState);
        }
    }

    function saveState() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (error) {
            console.error('Failed to persist workspace state:', error);
        }
    }

    function escapeHtml(text) {
        if (!text && text !== 0) return '';
        return text
            .toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function resolveModel(domain, selection) {
        if (selection && selection !== 'auto-routing') {
            return selection;
        }
        return MODEL_ROUTING[domain] || 'atlas-pro';
    }

    function activeAttachments() {
        return state.attachments.filter(item => item.enabled !== false);
    }

    function attachmentLabel(item) {
        if (item.type === 'file') {
            const sizeInfo = item.size ? ` (${Math.round(item.size / 1024)} KB)` : '';
            return `${item.name}${sizeInfo}`;
        }
        if (item.type === 'url') {
            return item.url;
        }
        return 'Context';
    }

    function renderModelDetails() {
        const option = modelSelect.selectedOptions[0];
        if (!option) return;
        const cost = option.getAttribute('data-cost');
        const description = option.getAttribute('data-description');
        modelDetails.innerHTML = `Cost: ${escapeHtml(cost)}. ${escapeHtml(description)}${state.selectedModel === 'auto-routing' ? ' Routed models: Atlas Pro (research), Code Strata (coding), Quant Sage (finance).' : ''}`;
    }

    function renderAttachments() {
        attachmentList.innerHTML = '';
        const attachments = state.attachments;
        if (!attachments.length) {
            const li = document.createElement('li');
            li.className = 'model-details';
            li.textContent = 'No attachments yet. Add files or URLs to share context across panels.';
            attachmentList.appendChild(li);
            return;
        }

        attachments.forEach(item => {
            const li = document.createElement('li');
            li.className = 'attachment-item';
            li.dataset.id = item.id;

            const span = document.createElement('span');
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = item.type === 'file' ? 'File' : 'URL';

            const label = document.createElement('span');
            label.textContent = attachmentLabel(item);

            span.appendChild(badge);
            span.appendChild(label);

            const controls = document.createElement('span');
            controls.style.display = 'inline-flex';
            controls.style.gap = '8px';
            controls.style.alignItems = 'center';

            const toggle = document.createElement('input');
            toggle.type = 'checkbox';
            toggle.checked = item.enabled !== false;
            toggle.setAttribute('aria-label', `Toggle attachment ${attachmentLabel(item)}`);
            toggle.addEventListener('change', () => {
                item.enabled = toggle.checked;
                saveState();
                announce(`${item.type === 'file' ? 'File' : 'URL'} attachment ${toggle.checked ? 'enabled' : 'disabled'}.`);
            });

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'secondary';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', () => {
                state.attachments = state.attachments.filter(att => att.id !== item.id);
                renderAttachments();
                saveState();
                announce('Attachment removed');
            });

            controls.appendChild(toggle);
            controls.appendChild(removeBtn);

            li.appendChild(span);
            li.appendChild(controls);
            attachmentList.appendChild(li);
        });
    }

    function renderMessages(domain) {
        const container = document.getElementById(`conversation-${domain}`);
        const messages = state.conversations[domain];
        if (!container) return;

        container.innerHTML = '';
        if (!messages.length) {
            const empty = document.createElement('p');
            empty.className = 'empty-state';
            empty.textContent = 'Start the conversation when you are ready.';
            container.appendChild(empty);
            return;
        }

        messages.forEach(message => {
            const wrapper = document.createElement('article');
            wrapper.className = `message ${message.role}`;
            wrapper.dataset.id = message.id;

            const meta = document.createElement('div');
            meta.className = 'message-meta';
            const speaker = message.role === 'user' ? 'You' : 'Assistant';
            const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const tokens = [];
            tokens.push(`${speaker} · ${timestamp}`);
            if (message.model) {
                tokens.push(`Model: ${message.model}`);
            }
            if (message.streaming) {
                tokens.push('Streaming');
            }
            meta.textContent = tokens.join(' | ');

            const body = document.createElement('div');
            body.className = 'message-body';
            if (message.streaming && !message.content) {
                body.innerHTML = '<span class="badge-pill">Streaming response&hellip;</span>';
            } else {
                body.innerHTML = escapeHtml(message.content || '');
            }

            wrapper.appendChild(meta);
            wrapper.appendChild(body);

            if (message.contexts && message.contexts.length) {
                const contextList = document.createElement('ul');
                contextList.className = 'message-context';
                contextList.setAttribute('role', 'list');
                message.contexts.forEach(ctx => {
                    const ctxItem = document.createElement('li');
                    ctxItem.textContent = ctx.type === 'file' ? ctx.name : ctx.url;
                    contextList.appendChild(ctxItem);
                });
                wrapper.appendChild(contextList);
            }

            if (message.role === 'assistant' && !message.streaming && message.content) {
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                const saveBtn = document.createElement('button');
                saveBtn.type = 'button';
                saveBtn.className = 'secondary';
                saveBtn.textContent = 'Save to notebook';
                saveBtn.setAttribute('aria-label', 'Save assistant response to notebook');
                saveBtn.addEventListener('click', () => {
                    addNotebookEntry(domain, message);
                });
                actions.appendChild(saveBtn);
                wrapper.appendChild(actions);
            }

            container.appendChild(wrapper);
        });

        container.scrollTop = container.scrollHeight;
    }

    function renderNotebook(domain) {
        const list = document.getElementById(`notebook-${domain}`);
        if (!list) return;
        list.innerHTML = '';
        const entries = state.notebooks[domain];
        if (!entries.length) {
            const empty = document.createElement('li');
            empty.className = 'model-details';
            empty.textContent = 'No saved notes yet.';
            list.appendChild(empty);
            return;
        }

        entries.forEach(entry => {
            const item = document.createElement('li');
            item.className = 'notebook-entry';
            const time = document.createElement('time');
            time.dateTime = new Date(entry.timestamp).toISOString();
            time.textContent = new Date(entry.timestamp).toLocaleString();
            const content = document.createElement('p');
            content.style.margin = '4px 0';
            content.textContent = entry.content;
            const remove = document.createElement('button');
            remove.type = 'button';
            remove.className = 'secondary';
            remove.textContent = 'Remove';
            remove.addEventListener('click', () => {
                state.notebooks[domain] = state.notebooks[domain].filter(note => note.id !== entry.id);
                renderNotebook(domain);
                saveState();
                announce('Notebook entry removed');
            });

            item.appendChild(time);
            item.appendChild(content);
            item.appendChild(remove);
            list.appendChild(item);
        });
    }

    function renderHistoryResults() {
        const term = historyInput.value.trim().toLowerCase();
        historyResults.innerHTML = '';
        if (!term) {
            const helper = document.createElement('li');
            helper.className = 'model-details';
            helper.textContent = 'Enter a search term to explore previous messages.';
            historyResults.appendChild(helper);
            return;
        }

        const matches = [];
        DOMAINS.forEach(domain => {
            state.conversations[domain].forEach(message => {
                const haystack = `${message.content} ${message.model || ''}`.toLowerCase();
                if (haystack.includes(term)) {
                    matches.push({ domain, message });
                }
            });
        });

        if (!matches.length) {
            const helper = document.createElement('li');
            helper.className = 'model-details';
            helper.textContent = 'No matching messages yet.';
            historyResults.appendChild(helper);
            return;
        }

        matches.slice(0, 12).forEach(({ domain, message }) => {
            const item = document.createElement('li');
            item.className = 'history-result';
            const title = document.createElement('strong');
            title.innerHTML = `${domain.charAt(0).toUpperCase() + domain.slice(1)} panel <span class="badge">${message.role}</span>`;
            const snippet = document.createElement('p');
            const content = message.content || '';
            snippet.textContent = content.slice(0, 160) + (content.length > 160 ? '…' : '');
            item.appendChild(title);
            item.appendChild(snippet);
            historyResults.appendChild(item);
        });
    }

    function addNotebookEntry(domain, message) {
        if (!message || !message.content) return;
        const entry = {
            id: generateId(),
            fromMessageId: message.id,
            content: message.content,
            timestamp: Date.now()
        };
        state.notebooks[domain].unshift(entry);
        renderNotebook(domain);
        saveState();
        announce('Response saved to notebook');
    }

    function simulateStreaming(domain, messageId, finalText) {
        const container = document.getElementById(`conversation-${domain}`);
        if (container) {
            container.setAttribute('aria-busy', 'true');
        }
        let index = 0;
        const interval = setInterval(() => {
            const messages = state.conversations[domain];
            const target = messages.find(msg => msg.id === messageId);
            if (!target) {
                clearInterval(interval);
                if (container) container.removeAttribute('aria-busy');
                return;
            }
            index += 3;
            target.content = finalText.slice(0, index);
            renderMessages(domain);
            if (target.content.length >= finalText.length) {
                clearInterval(interval);
                target.streaming = false;
                renderMessages(domain);
                if (container) container.removeAttribute('aria-busy');
                saveState();
            }
        }, 60);
    }

    function composeAssistantResponse(domain, prompt, model) {
        const contexts = activeAttachments();
        const contextSummary = contexts.length
            ? ` Referenced ${contexts.length} context item${contexts.length > 1 ? 's' : ''} while reasoning.`
            : ' No external context supplied in this turn.';
        const domainPreamble = {
            research: 'Synthesizing peer-reviewed studies, comparative metrics, and methodology checks.',
            coding: 'Surveying API docs, recent commits, and static-analysis heuristics for implementation guidance.',
            finance: 'Evaluating market indicators, cash flow sensitivity, and risk-weighted projections.'
        }[domain];
        const modelCapabilities = {
            'atlas-pro': 'balanced insights blending qualitative and quantitative evidence.',
            'code-strata': 'step-by-step code reasoning, static analysis, and diff-ready output.',
            'quant-sage': 'probabilistic finance modeling with stress testing narratives.',
            'nova-lite': 'rapid ideation focused on lightweight brainstorming.',
            'auto-routing': 'delegated orchestration to specialized experts.'
        };

        return `${domainPreamble || 'Providing informed guidance.'} Using ${model} for this turn delivers ${modelCapabilities[model] || 'helpful reasoning.'} Key takeaways for your prompt “${prompt}”:${contextSummary}`;
    }

    function handleFormSubmit(event) {
        event.preventDefault();
        const form = event.currentTarget;
        const domain = form.getAttribute('data-domain');
        const textarea = form.querySelector('textarea');
        const text = textarea.value.trim();
        if (!text) {
            textarea.focus();
            return;
        }

        const timestamp = Date.now();
        const contexts = activeAttachments().map(item => ({ ...item }));

        const userMessage = {
            id: generateId(),
            role: 'user',
            content: text,
            timestamp,
            contexts
        };
        state.conversations[domain].push(userMessage);
        textarea.value = '';

        const resolvedModel = resolveModel(domain, state.selectedModel);
        const assistantMessage = {
            id: generateId(),
            role: 'assistant',
            content: '',
            timestamp: Date.now(),
            model: resolvedModel,
            streaming: true,
            contexts
        };
        state.conversations[domain].push(assistantMessage);
        renderMessages(domain);
        renderHistoryResults();
        saveState();

        const responseText = composeAssistantResponse(domain, text, resolvedModel);
        simulateStreaming(domain, assistantMessage.id, responseText);
    }

    function wireForms() {
        document.querySelectorAll('form.message-form').forEach(form => {
            form.addEventListener('submit', handleFormSubmit);
        });
    }

    function handleFileAttachment(event) {
        const files = Array.from(event.target.files || []);
        if (!files.length) return;
        files.forEach(file => {
            state.attachments.push({
                id: generateId(),
                type: 'file',
                name: file.name,
                size: file.size,
                enabled: true
            });
        });
        event.target.value = '';
        renderAttachments();
        saveState();
        announce(`${files.length} file${files.length !== 1 ? 's' : ''} attached.`);
    }

    function handleUrlAttachment() {
        const input = document.getElementById('urlInput');
        const url = input.value.trim();
        if (!url) {
            input.focus();
            return;
        }
        try {
            const normalized = new URL(url, window.location.href).href;
            state.attachments.push({
                id: generateId(),
                type: 'url',
                url: normalized,
                enabled: true
            });
            input.value = '';
            renderAttachments();
            saveState();
            announce('URL context attached.');
        } catch (error) {
            announce('Unable to attach URL. Please include a valid protocol.');
            input.focus();
        }
    }

    function onModelChange(event) {
        state.selectedModel = event.target.value;
        renderModelDetails();
        saveState();
        announce(`Model selection updated to ${event.target.selectedOptions[0].textContent}`);
    }

    function recordAccessibilityReview() {
        const timestamp = new Date().toLocaleString();
        const bulletItems = [
            'Landmarks provided via main, region, and log roles for screen reader navigation.',
            'Form inputs and interactive buttons expose descriptive labels with focus rings.',
            'Streaming responses announced with aria-live regions and busy indicators to avoid confusion.',
            'Keyboard-only flows validated for sending messages, toggling attachments, and saving notebooks.'
        ];
        accessibilityLog.dataset.reviewed = 'true';
        accessibilityLog.innerHTML = `<strong>${escapeHtml(timestamp)}</strong>: Accessibility review completed. Key checks:` +
            '<ul>' + bulletItems.map(item => `<li>${escapeHtml(item)}</li>`).join('') + '</ul>';
    }

    function runWorkspaceTests() {
        const results = [];

        function testPersistence() {
            const key = `${STORAGE_KEY}-test`;
            const sample = {
                conversations: {
                    research: [{ id: '1', role: 'user', content: 'Persist me', timestamp: Date.now() }]
                }
            };
            try {
                localStorage.setItem(key, JSON.stringify(sample));
                const loaded = JSON.parse(localStorage.getItem(key));
                localStorage.removeItem(key);
                const passed = loaded?.conversations?.research?.[0]?.content === 'Persist me';
                return passed
                    ? { name: 'Conversation persistence', status: 'pass', detail: 'State round-trips through storage.' }
                    : { name: 'Conversation persistence', status: 'fail', detail: 'Mismatch after storage round-trip.' };
            } catch (error) {
                return { name: 'Conversation persistence', status: 'fail', detail: error.message };
            }
        }

        function testRouting() {
            const autoResearch = resolveModel('research', 'auto-routing');
            const autoCoding = resolveModel('coding', 'auto-routing');
            const autoFinance = resolveModel('finance', 'auto-routing');
            const manual = resolveModel('finance', 'quant-sage');
            const passed = autoResearch === 'atlas-pro' && autoCoding === 'code-strata' && autoFinance === 'quant-sage' && manual === 'quant-sage';
            return passed
                ? { name: 'Multi-model routing', status: 'pass', detail: 'Auto-routing maps each panel to its specialist model.' }
                : { name: 'Multi-model routing', status: 'fail', detail: 'Routing map returned unexpected models.' };
        }

        function testAccessibilityLog() {
            const recorded = accessibilityLog.dataset.reviewed === 'true' && accessibilityLog.textContent.trim().length > 0;
            return recorded
                ? { name: 'Accessibility review recorded', status: 'pass', detail: 'Latest review entry present in log.' }
                : { name: 'Accessibility review recorded', status: 'fail', detail: 'Log entry missing or empty.' };
        }

        results.push(testPersistence());
        results.push(testRouting());
        results.push(testAccessibilityLog());

        renderTestResults(results);
        console.table(results);
    }

    function renderTestResults(results) {
        const container = document.getElementById('testResults');
        container.innerHTML = '';
        results.forEach(result => {
            const li = document.createElement('li');
            const statusClass = result.status === 'pass' ? 'test-pass' : 'test-fail';
            li.innerHTML = `<span class="${statusClass}">${escapeHtml(result.status.toUpperCase())}</span> · <strong>${escapeHtml(result.name)}</strong> &mdash; ${escapeHtml(result.detail)}`;
            container.appendChild(li);
        });
    }

    function bindEvents() {
        modelSelect.addEventListener('change', onModelChange);
        document.getElementById('fileInput').addEventListener('change', handleFileAttachment);
        document.getElementById('addUrlBtn').addEventListener('click', handleUrlAttachment);
        document.getElementById('urlInput').addEventListener('keypress', event => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleUrlAttachment();
            }
        });
        historyInput.addEventListener('input', renderHistoryResults);
        rerunTestsBtn.addEventListener('click', runWorkspaceTests);
    }

    loadState();
    modelSelect.value = state.selectedModel;
    renderModelDetails();
    renderAttachments();
    DOMAINS.forEach(domain => {
        renderMessages(domain);
        renderNotebook(domain);
    });
    recordAccessibilityReview();
    wireForms();
    bindEvents();
    renderHistoryResults();
    runWorkspaceTests();
})();
</script>
</body>
</html>
